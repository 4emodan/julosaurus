<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Pile</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="title">My Photo Pile</div>
    <div id="table"></div>

    <div class="controls">
        <button id="upload-btn">Upload Photo</button>
        <input type="file" id="file-input" accept="image/*" multiple>
    </div>

    <script>
        const table = document.getElementById('table');
        const fileInput = document.getElementById('file-input');
        const uploadBtn = document.getElementById('upload-btn');
        let highestZ = 1;
        let hasBackend = true;

        const DEFAULT_PHOTOS = [
            'images/sample1.jpg',
            'images/sample2.jpg',
            'images/sample3.jpg',
            'images/sample4.jpg'
        ];

        async function fetchPhotos() {
            try {
                const response = await fetch('/photos');
                if (!response.ok) throw new Error('Backend not available');
                const photos = await response.json();
                table.innerHTML = '';
                photos.forEach(photo => addPhotoToTable(photo.url));
                hasBackend = true;
            } catch (error) {
                console.log('Running in static mode (no backend found)');
                hasBackend = false;
                table.innerHTML = '';
                DEFAULT_PHOTOS.forEach(url => addPhotoToTable(url));
            }
        }

        function addPhotoToTable(url) {
            const container = document.createElement('div');
            container.className = 'photo-container';

            const img = document.createElement('img');
            img.src = url;
            // Handle broken images (e.g. if default photos are missing)
            img.onerror = () => {
                container.remove();
            };

            container.appendChild(img);

            // Random position and rotation
            const x = Math.random() * (window.innerWidth - 300) + 50;
            const y = Math.random() * (window.innerHeight - 300) + 50;
            const rotation = Math.random() * 40 - 20;

            container.style.left = `${x}px`;
            container.style.top = `${y}px`;
            container.style.transform = `rotate(${rotation}deg)`;
            container.style.zIndex = highestZ++;

            container.addEventListener('mousedown', bringToFront);
            makeDraggable(container);

            table.appendChild(container);
        }

        function bringToFront(e) {
            this.style.zIndex = highestZ++;
        }

        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            element.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                if (e.button !== 0) return; // Only left click
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                bringToFront.call(element);
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        uploadBtn.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', async () => {
            const files = Array.from(fileInput.files);
            if (files.length === 0) return;

            for (const file of files) {
                if (hasBackend) {
                    const formData = new FormData();
                    formData.append('file', file);

                    try {
                        const response = await fetch('/upload', {
                            method: 'POST',
                            body: formData
                        });
                        if (response.ok) {
                            const photo = await response.json();
                            addPhotoToTable(photo.url);
                        } else {
                            console.error(`Upload failed for ${file.name}`);
                        }
                    } catch (error) {
                        console.error('Error uploading to backend:', error);
                        hasBackend = false; // Fallback to local
                        addPhotoToTable(URL.createObjectURL(file));
                    }
                } else {
                    // Local only mode
                    addPhotoToTable(URL.createObjectURL(file));
                }
            }
            fileInput.value = '';
        });

        fetchPhotos();
    </script>
</body>
</html>
